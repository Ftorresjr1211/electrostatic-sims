<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Electrostatic Deflection Sim (Moving Rod + Distance Label)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 18px; }
    .wrap { display: grid; grid-template-columns: 560px 1fr; gap: 16px; align-items: start; }
    canvas { border: 1px solid #ccc; border-radius: 12px; background: #fff; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; background: #fafafa; }
    label { display:block; margin-top: 8px; font-weight: 700; }
    input[type="range"] { width: 100%; }
    .kvs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .kv { border: 1px solid #ddd; border-radius: 10px; background: #fff; padding: 10px; }
    .kv .k { font-size: 0.9rem; color: #444; }
    .kv .v { font-size: 1.25rem; font-weight: 800; }
    .small { font-size: 0.92rem; color: #333; line-height: 1.35; }
    .legend { margin-top: 10px; font-size: 0.92rem; }
    .swatch { display:inline-block; width: 12px; height: 12px; border-radius: 3px; margin-right: 6px; vertical-align: -2px; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <h2>Electrostatic Force vs Distance — Moving Rod + Force Vector</h2>

  <div class="wrap">
    <canvas id="c" width="560" height="520"></canvas>

    <div class="card">
      <p class="small">
        Adjust the <b>distance</b> between the charged rod and the pendulum bob.
        The rod visibly moves, the bob swings and settles, and the <b>electrostatic force vector</b> is drawn on the bob.
      </p>

      <label for="dist">Distance from rod to bob (cm): <span id="distVal" class="mono"></span></label>
      <input id="dist" type="range" min="2" max="30" step="0.5" value="12" />

      <div class="kvs">
        <div class="kv">
          <div class="k">Deflection angle, θ (deg)</div>
          <div class="v" id="thetaOut">—</div>
        </div>
        <div class="kv">
          <div class="k">Electrostatic force (relative)</div>
          <div class="v" id="forceOut">—</div>
        </div>
      </div>

      <div class="legend">
        <div><span class="swatch" style="background:#444"></span>Charged rod</div>
        <div><span class="swatch" style="background:#000"></span>String</div>
        <div><span class="swatch" style="background:#2b6"></span>Pendulum bob</div>
        <div><span class="swatch" style="background:#d33"></span>Electrostatic force vector (Fₑ)</div>
      </div>

      <p class="small" style="margin-top:12px;">
        Model: force increases as distance decreases (inverse-square style). This is a <b>learning model</b> to visualize cause and effect.
      </p>
    </div>
  </div>

  <script>
    // =========================
    // Canvas + UI
    // =========================
    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d");

    const distSlider = document.getElementById("dist");
    const distVal = document.getElementById("distVal");
    const thetaOut = document.getElementById("thetaOut");
    const forceOut = document.getElementById("forceOut");

    // =========================
    // Parameters (tuned for visuals)
    // =========================
    const g = 9.81;        // m/s^2
    const m = 0.015;       // kg
    const L = 0.25;        // m (string length)
    const K = 2.6e-5;      // N*m^2 (tunable "charge strength")
    const minR_m = 0.02;   // 2 cm minimum

    // Pendulum dynamics
    let theta = 0;         // rad
    let omega = 0;         // rad/s
    const kSpring = 18;    // pulls toward equilibrium
    const bDamp = 4;       // damping

    // Rod motion dynamics
    let rodX = 470;        // current rod x in px
    let rodV = 0;          // rod velocity (px/s)
    const rodKS = 28;      // rod spring
    const rodBD = 6;       // rod damping

    // Geometry
    const pivot = { x: 230, y: 90 };
    const pxPerMeter = 900; // scale
    const rodYTop = 120;
    const rodYBot = 430;

    // Slider state
    let rTarget_cm = parseFloat(distSlider.value);

    // =========================
    // Helpers
    // =========================
    function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

    function rMeters() {
      return Math.max(minR_m, rTarget_cm / 100);
    }

    function electroForce(r_m) {
      return K / (r_m * r_m); // N
    }

    function equilibriumTheta(r_m) {
      const Fe = electroForce(r_m);
      return Math.atan(Fe / (m * g)); // rad
    }

    function bobPos(thetaRad) {
      return {
        x: pivot.x + (L * pxPerMeter) * Math.sin(thetaRad),
        y: pivot.y + (L * pxPerMeter) * Math.cos(thetaRad)
      };
    }

    function arrow(x1, y1, x2, y2, color, label) {
      ctx.save();
      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      ctx.lineWidth = 3;

      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();

      const ang = Math.atan2(y2 - y1, x2 - x1);
      const headLen = 12;
      ctx.beginPath();
      ctx.moveTo(x2, y2);
      ctx.lineTo(x2 - headLen * Math.cos(ang - Math.PI/7), y2 - headLen * Math.sin(ang - Math.PI/7));
      ctx.lineTo(x2 - headLen * Math.cos(ang + Math.PI/7), y2 - headLen * Math.sin(ang + Math.PI/7));
      ctx.closePath();
      ctx.fill();

      if (label) {
        ctx.font = "bold 14px system-ui, Arial";
        ctx.fillText(label, x2 + 8, y2 - 8);
      }
      ctx.restore();
    }

    // Convert desired distance to where the rod should be (rod is to the right of bob)
    function targetRodX(bobX) {
      const r_px = (rTarget_cm / 100) * pxPerMeter;
      // place rod to the right of bob by r_px, then clamp to canvas
      return clamp(bobX + r_px, 320, 530);
    }

    function updateReadouts(thetaRad) {
      const deg = thetaRad * 180 / Math.PI;
      thetaOut.textContent = deg.toFixed(1) + "°";

      // Show a "relative" force number that's easy to read (not necessary to be perfect)
      const Fe = electroForce(rMeters());
      forceOut.textContent = Fe.toExponential(2) + " N";
    }

    // =========================
    // Draw
    // =========================
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Light grid
      ctx.save();
      ctx.globalAlpha = 0.13;
      ctx.strokeStyle = "#999";
      for (let x = 20; x < canvas.width; x += 40) {
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
      }
      for (let y = 20; y < canvas.height; y += 40) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
      }
      ctx.restore();

      // Title
      ctx.save();
      ctx.fillStyle = "#111";
      ctx.font = "bold 16px system-ui, Arial";
      ctx.fillText("Deflection from Electrostatic Attraction", 18, 28);
      ctx.restore();

      // Pivot
      ctx.save();
      ctx.fillStyle = "#111";
      ctx.beginPath();
      ctx.arc(pivot.x, pivot.y, 6, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      // Bob + string
      const b = bobPos(theta);
      ctx.save();
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(pivot.x, pivot.y);
      ctx.lineTo(b.x, b.y);
      ctx.stroke();

      ctx.fillStyle = "#2b6";
      ctx.beginPath();
      ctx.arc(b.x, b.y, 16, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = "#195";
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();

      // Rod (MOVING)
      ctx.save();
      ctx.lineWidth = 10;
      ctx.strokeStyle = "#444";
      ctx.beginPath();
      ctx.moveTo(rodX, rodYTop);
      ctx.lineTo(rodX, rodYBot);
      ctx.stroke();

      ctx.font = "bold 14px system-ui, Arial";
      ctx.fillStyle = "#444";
      ctx.fillText("Charged rod", rodX - 45, rodYTop - 12);
      ctx.restore();

      // Angle arc
      ctx.save();
      const arcR = 55;
      ctx.strokeStyle = "#555";
      ctx.lineWidth = 2;
      const start = Math.PI / 2;      // down
      const end = start - theta;
      ctx.beginPath();
      ctx.arc(pivot.x, pivot.y, arcR, start, end, theta > 0);
      ctx.stroke();
      ctx.fillStyle = "#333";
      ctx.font = "bold 14px system-ui, Arial";
      ctx.fillText("θ", pivot.x + 8, pivot.y + arcR + 12);
      ctx.restore();

      // Force vector on bob (points toward rod)
      const Fe = electroForce(rMeters());
      const FeScale = 6000;
      const dx = Math.min(160, Fe * FeScale);
      arrow(b.x, b.y, b.x + dx, b.y, "#d33", "Fₑ");

      // Distance label + line (shows ACTUAL drawn distance in cm)
      // We draw a dashed line from rod to the bob at bob's height.
      const drawnDist_px = Math.max(0, rodX - b.x);
      const drawnDist_cm = (drawnDist_px / pxPerMeter) * 100;

      ctx.save();
      ctx.strokeStyle = "#888";
      ctx.setLineDash([6, 6]);
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(b.x, b.y);
      ctx.lineTo(rodX, b.y);
      ctx.stroke();
      ctx.setLineDash([]);

      ctx.fillStyle = "#666";
      ctx.font = "13px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText(`${drawnDist_cm.toFixed(1)} cm`, (rodX + b.x)/2 - 18, b.y - 10);
      ctx.restore();
    }

    // =========================
    // Animation loop
    // =========================
    let last = performance.now();
    function tick(now) {
      const dt = Math.min(0.03, (now - last) / 1000);
      last = now;

      // Compute equilibrium for current target distance
      const r_m = rMeters();
      const thetaEq = equilibriumTheta(r_m);

      // Pendulum dynamics (damped toward thetaEq)
      const alpha = kSpring * (thetaEq - theta) - bDamp * omega;
      omega += alpha * dt;
      theta += omega * dt;

      // limit angle for display
      const maxTheta = 65 * Math.PI / 180;
      theta = clamp(theta, 0, maxTheta);

      // Rod dynamics (moves to keep chosen distance from current bob position)
      const b = bobPos(theta);
      const rodTarget = targetRodX(b.x);

      const rodA = rodKS * (rodTarget - rodX) - rodBD * rodV;
      rodV += rodA * dt;
      rodX += rodV * dt;

      // keep rod in bounds
      rodX = clamp(rodX, 320, 530);

      updateReadouts(theta);
      draw();
      requestAnimationFrame(tick);
    }

    // =========================
    // UI wiring
    // =========================
    function refreshUI() {
      rTarget_cm = parseFloat(distSlider.value);
      distVal.textContent = rTarget_cm.toFixed(1);
    }
    distSlider.addEventListener("input", refreshUI);

    // init
    refreshUI();
    updateReadouts(theta);
    requestAnimationFrame(tick);
  </script>
</body>
</html>
